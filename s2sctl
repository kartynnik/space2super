#! /bin/sh
logfile="$HOME/.space2super"
program="${0%/*}/space2super"

start() {
    pgrep --full --count "$program" > /dev/null && { echo "Space2Super is already active" >&2; return; }

    newmap=$(xmodmap -pke | grep -E "^keycode[[:blank:]]*?65" | perl -pe "s/ space/ Super_L/g")
    xmodmap -e "$newmap"
    xmodmap -e "keycode 255 = space space space space space"

    nohup "$program" >> "$logfile" 2>&1 &
    echo "Space2Super is now active (log file: $logfile)"
}

stop() {
    newmap=$(xmodmap -pke | grep -E "^keycode[[:blank:]]*?65" | perl -pe "s/ Super_L/ space/g")
    xmodmap -e "$newmap"
    xmodmap -e "keycode 255 ="

    pkill -INT space2super
}

case "$1" in
    start)
        echo "Starting Space2Super..."
        start
        ;;
    stop)
        echo "Stopping Space2Super..."
        stop
        ;;
    restart)
        $0 stop
        $0 start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}" >&2
        ;;
esac
